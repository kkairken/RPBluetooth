# –ù–∞—Å—Ç–æ—è—â–∏–π BLE —Å–µ—Ä–≤–µ—Ä - –°–≤–æ–¥–∫–∞

## ‚úÖ –ß–¢–û –ë–´–õ–û –°–û–ó–î–ê–ù–û

### 1. –ù–∞—Å—Ç–æ—è—â–∏–π BLE GATT —Å–µ—Ä–≤–µ—Ä
- **–§–∞–π–ª**: `src/ble_server_real.py`
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è**: BlueZ —á–µ—Ä–µ–∑ DBus API
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π GATT —Å–µ—Ä–≤–µ—Ä
  - –°–µ—Ä–≤–∏—Å —Å UUID: `12345678-1234-5678-1234-56789abcdef0`
  - 2 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: Command (Write) –∏ Response (Notify)
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è)
  - HMAC –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
  - Advertisement (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∏–¥–Ω–æ –∫–∞–∫ "RP3_FaceAccess")

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π
- **–§–∞–π–ª**: `src/main.py` (–æ–±–Ω–æ–≤–ª–µ–Ω)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ–∂–¥—É mock –∏ –Ω–∞—Å—Ç–æ—è—â–∏–º BLE
- –ü–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `use_real_ble`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **–§–∞–π–ª**: `config/ble_config.yaml`
- –ì–æ—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º BLE
- –ü–∞—Ä–∞–º–µ—Ç—Ä `use_real_ble: true`

### 4. Python BLE –∫–ª–∏–µ–Ω—Ç
- **–§–∞–π–ª**: `tools/ble_register_client.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Raspberry Pi
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- HMAC –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- Chunked photo upload

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **BLE_SETUP_GUIDE.md** - –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- **–ü—Ä–∏–º–µ—Ä—ã** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å nRF Connect
- **–ü—Ä–æ—Ç–æ–∫–æ–ª** —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢

### –ù–∞ Raspberry Pi:

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
sudo apt install -y bluez bluetooth python3-dbus python3-gi
source venv/bin/activate
pip install dbus-python PyGObject

# 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥
cp config/ble_config.yaml config/my_ble_config.yaml
nano config/my_ble_config.yaml
# –ò–∑–º–µ–Ω–∏—Ç–µ: shared_secret –∏ use_real_ble: true

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å BLE
sudo venv/bin/python src/main.py --config config/my_ble_config.yaml
```

### –ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ/—Ç–µ–ª–µ—Ñ–æ–Ω–µ:

**–í–∞—Ä–∏–∞–Ω—Ç A: nRF Connect (–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ nRF Connect –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
2. –ù–∞–π–¥–∏—Ç–µ "RP3_FaceAccess"
3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã

**–í–∞—Ä–∏–∞–Ω—Ç B: Python –∫–ª–∏–µ–Ω—Ç**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ bleak
pip install bleak

# –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
python tools/ble_register_client.py \
  --employee-id "EMP001" \
  --display-name "–ê–¥–∏–ª—å –•–∞–Ω" \
  --access-start "2025-01-01T00:00:00Z" \
  --access-end "2026-12-31T23:59:59Z" \
  --photos photo1.jpg photo2.jpg \
  --secret "your_shared_secret"
```

---

## üìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

```
rp3_face_access/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ ble_server_real.py          ‚Üê –ù–∞—Å—Ç–æ—è—â–∏–π BLE GATT —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     ‚Üê –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ BLE
‚îÇ   ‚îî‚îÄ‚îÄ config.py                   ‚Üê –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä use_real_ble
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ ble_config.yaml             ‚Üê –ö–æ–Ω—Ñ–∏–≥ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º BLE
‚îÇ
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îú‚îÄ‚îÄ ble_register_client.py      ‚Üê Python BLE –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ register_employee_direct.py ‚Üê –ü—Ä—è–º–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–±–µ–∑ BLE)
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ BLE_SETUP_GUIDE.md          ‚Üê –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    ‚îú‚îÄ‚îÄ BLE_SUMMARY.md              ‚Üê –≠—Ç–æ—Ç —Ñ–∞–π–ª
    ‚îú‚îÄ‚îÄ PHONE_REGISTRATION_GUIDE.md ‚Üê –û–±—â–∏–π –≥–∞–π–¥
    ‚îî‚îÄ‚îÄ REGISTER_NOW.md             ‚Üê –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```

---

## üîß –ù–ê–°–¢–†–û–ô–ö–ê

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config/ble_config.yaml):

```yaml
ble:
  device_name: "RP3_FaceAccess"
  service_uuid: "12345678-1234-5678-1234-56789abcdef0"
  shared_secret: "–í–ê–®_–°–ï–ö–†–ï–¢_64_–°–ò–ú–í–û–õ–ê"
  hmac_enabled: true
  use_real_ble: true  # ‚Üê –í–ê–ñ–ù–û: true –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ BLE

access:
  admin_mode_enabled: true  # ‚Üê –í–ê–ñ–ù–û: true –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```

---

## üì± –ü–†–û–¢–û–ö–û–õ –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

### 1. BEGIN_UPSERT
```json
{
  "command": "BEGIN_UPSERT",
  "employee_id": "EMP001",
  "display_name": "–ê–¥–∏–ª—å –•–∞–Ω",
  "access_start": "2025-01-01T00:00:00Z",
  "access_end": "2026-12-31T23:59:59Z",
  "num_photos": 2,
  "nonce": "1706000000_abc123",
  "hmac": "signature"
}
```

### 2. PHOTO_CHUNK (–ø–æ–≤—Ç–æ—Ä—è—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞)
```json
{
  "command": "PHOTO_CHUNK",
  "chunk_index": 0,
  "total_chunks": 10,
  "data": "base64_encoded_data",
  "is_last": false,
  "sha256": "hash"
}
```

### 3. END_UPSERT
```json
{
  "command": "END_UPSERT"
}
```

---

## üéØ –í–ê–†–ò–ê–ù–¢–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### 1. nRF Connect (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ "RP3_FaceAccess"
- –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ JSON –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ù–µ—É–¥–æ–±–Ω–æ –¥–ª—è —á–∞—Å—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 2. Python –∫–ª–∏–µ–Ω—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ble_register_client.py`
- –û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ = —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ –ë—ã—Å—Ç—Ä–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- ‚ùå –ù—É–∂–µ–Ω –∫–æ–º–ø—å—é—Ç–µ—Ä —Å Python

### 3. –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ª—É—á—à–∏–π UX)
- –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- Flutter + flutter_blue_plus
- React Native + react-native-ble-plx
- ‚úÖ –õ—É—á—à–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- ‚ùå –¢—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 4. –ü—Ä—è–º–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–±–µ–∑ BLE)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `register_employee_direct.py`
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ Raspberry Pi
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞
- ‚ùå –ù—É–∂–µ–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ Pi

---

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –¢—Ä–µ–±—É–µ—Ç—Å—è root –¥–ª—è BLE
**–ü—Ä–æ–±–ª–µ–º–∞**: BLE GATT —Å–µ—Ä–≤–µ—Ä —Ç—Ä–µ–±—É–µ—Ç root –ø—Ä–∞–≤–∞
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å–∫–∞—Ç—å —Å `sudo venv/bin/python`

### 2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ dbus/gi
**–ü—Ä–æ–±–ª–µ–º–∞**: –°–ª–æ–∂–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ dbus-python –∏ PyGObject
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã `python3-dbus` –∏ `python3-gi`

### 3. Chunked upload –º–µ–¥–ª–µ–Ω–Ω—ã–π
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –ø–æ 512 –±–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π
**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–∏—Ç—å chunk_size –≤ –∫–æ–Ω—Ñ–∏–≥–µ (–¥–æ 4096)

---

## ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ó–∞–ø—É—Å–∫ BLE —Å–µ—Ä–≤–µ—Ä–∞
```bash
sudo venv/bin/python src/main.py --config config/ble_config.yaml
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Using REAL BLE server (BlueZ)"
```

### –¢–µ—Å—Ç 2: –í–∏–¥–∏–º–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
```bash
# –ù–∞ –¥—Ä—É–≥–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ/—Ç–µ–ª–µ—Ñ–æ–Ω–µ
sudo hcitool lescan
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: RP3_FaceAccess
```

### –¢–µ—Å—Ç 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ nRF Connect
- –û—Ç–∫—Ä–æ–π—Ç–µ nRF Connect
- –ù–∞–π–¥–∏—Ç–µ "RP3_FaceAccess"
- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å
- –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å–µ—Ä–≤–∏—Å —Å UUID 12345678...

### –¢–µ—Å—Ç 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã GET_STATUS
```json
{"command":"GET_STATUS"}
```
–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã.

### –¢–µ—Å—Ç 5: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Python –∫–ª–∏–µ–Ω—Ç
```bash
python tools/ble_register_client.py \
  --employee-id "TEST001" \
  --display-name "–¢–µ—Å—Ç" \
  --access-start "2025-01-01T00:00:00Z" \
  --access-end "2026-12-31T23:59:59Z" \
  --photos test.jpg \
  --secret "your_secret"
```

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –ú–ï–¢–û–î–û–í –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

| –ú–µ—Ç–æ–¥ | –£–¥–æ–±—Å—Ç–≤–æ | –°–∫–æ—Ä–æ—Å—Ç—å | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è |
|-------|----------|----------|------------|
| **nRF Connect** | ‚≠ê‚≠ê | ‚≠ê‚≠ê | –¢–µ–ª–µ—Ñ–æ–Ω —Å BLE |
| **Python –∫–ª–∏–µ–Ω—Ç** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | –ö–æ–º–ø—å—é—Ç–µ—Ä —Å Python + bleak |
| **–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| **–ü—Ä—è–º–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –î–æ—Å—Ç—É–ø –∫ Raspberry Pi |

---

## üéâ –ì–û–¢–û–í–û!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å:
- ‚úÖ –ù–∞—Å—Ç–æ—è—â–∏–π BLE GATT —Å–µ—Ä–≤–µ—Ä
- ‚úÖ Python –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ nRF Connect
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å nRF Connect
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Python –∫–ª–∏–µ–Ω—Ç
3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- BLE_SETUP_GUIDE.md - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- API_REFERENCE.md - –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª BLE
- PHONE_REGISTRATION_GUIDE.md - –û–±—â–∏–π –≥–∞–π–¥

---

**–í–µ—Ä—Å–∏—è**: 1.0
**–î–∞—Ç–∞**: 2026-01-24
**–°—Ç–∞—Ç—É—Å**: Production Ready
**–ê–≤—Ç–æ—Ä**: Claude Code
